C51 COMPILER V9.60.7.0   MAIN                                                              09/24/2024 17:32:50 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: E:\ARM_KEIL\Arm\Keil_v5\C51\BIN\C51.EXE source\main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND P
                    -RINT(.\Listings\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          /*main.c*/
   2          #include "include/18B20.h"
   3          #include "include/ComCDT.h"
   4          #include "include/Relay.h"
   5          #include "include/buzzer.h"
   6          #include "include/pid_controller.h"
   7          #include "include/IKeyEvent.h"
   8          
   9          #define TIMER_0_RELOADS_VALUE 1000    // å®šæ—¶å™¨0é‡è£…å€¼ï¼Œä¸ºæ¯1ms
  10          #define TEMP_CONVERSION_FACTOR 0.0625 // æ¸©åº¦è½¬æ¢ç³»æ•°
  11          #define LOWER_TEMP_LIMIT 25            
  12          #define UPPER_TEMP_LIMIT 30
  13          #define TARGET_TEMPERATURE 28 // ç›®æ ‡æ¸©åº¦
  14          
  15          typedef struct
  16          {
  17              void (*taskFunction)(void);
  18              unsigned int period;
  19              unsigned int nextExecution;
  20          } Task;
  21          
  22          #define MAX_TASKS 5
  23          Task tasks[MAX_TASKS];
  24          unsigned char taskCount = 0;
  25          
  26          // è°ƒåº¦å™¨å‡½æ•°å£°æ˜
  27          void initializeSystem();
  28          void addTask(void (*taskFunction)(void), unsigned int period);
  29          void scheduler();
  30          
  31          // ä»»åŠ¡å‡½æ•°å£°æ˜
  32          void taskTemperatureUpdate();
  33          void taskControlRelay();
  34          
  35          // å®šæ—¶å™¨å‡½æ•°å£°æ˜
  36          void initializeTimer0();
  37          void timer0InterruptHandling(void);
  38          
  39          // å…¨å±€å˜é‡å£°æ˜
  40          unsigned int currentTime = 0;                   // å½“å‰æ—¶é—´ï¼Œä¸ºä¸­æ–­å‘¨æœŸçš„æ•´æ•°å€ï¼Œæ—¶é—´å•ä
             -½ä¸º1ms
  41          unsigned char temperature = 0;                  // æ¸©åº¦å€¼
  42          unsigned char integerPart = 0, decimalPart = 0; // æ¸©åº¦çš„æ•´æ•°éƒ¨åˆ†å’Œå°æ•°éƒ¨åˆ†
  43          unsigned char setpoint=TARGET_TEMPERATURE; // ç›®æ ‡æ¸©åº¦
  44          unsigned char integral=0;  // ç§¯åˆ†å€¼
  45          unsigned char previous_error=0; // ä¸Šä¸€ä¸ªè¯¯å·®
  46          bit displayTemperatureOrTime=1;
  47          
  48          void main(void)
  49          {
  50   1          // åˆå§‹åŒ–DS19B20æ¨¡å—
  51   1          Init_DS18B20();
  52   1      
  53   1          // åˆå§‹åŒ–è°ƒåº¦å™¨
C51 COMPILER V9.60.7.0   MAIN                                                              09/24/2024 17:32:50 PAGE 2   

  54   1          initializeSystem();
  55   1      
  56   1          // æ— é™å¾ªç¯
  57   1          while (1)
  58   1          {
  59   2              // æ‰«æé”®ç›˜äº‹ä»¶
  60   2              checkButtons();
  61   2      
  62   2              // è°ƒç”¨è°ƒåº¦å™¨
  63   2              scheduler();
  64   2          }
  65   1      }
  66          
  67          // åˆå§‹åŒ–ç³»ç»Ÿå‡½æ•°
  68          void initializeSystem()
  69          {
  70   1          // åˆå§‹åŒ–å®šæ—¶å™¨0
  71   1          initializeTimer0();
  72   1          // æ·»åŠ ä»»åŠ¡åˆ°è°ƒåº¦å™¨
  73   1          addTask(taskTemperatureUpdate, 8); // æ¯8sæ‰§è¡Œä¸€æ¬¡æ¸©åº¦æ˜¾ç¤ºæ›´æ–°
  74   1          addTask(taskControlRelay, 1000);   // æ¯1sæ—¶é—´å•ä½æ‰§è¡Œä¸€æ¬¡ç»§ç”µå™¨æ§åˆ¶
  75   1      }
  76          
  77          // åˆå§‹åŒ–å®šæ—¶å™¨
  78          void initializeTimer0()
  79          {
  80   1          // è®¾ç½®å®šæ—¶å™¨0ä¸ºæ¨¡å¼1ï¼ˆ16ä½å®šæ—¶å™¨/è®¡æ•°å™¨æ¨¡å¼ï¼‰
  81   1          TMOD &= 0xF0; // æ¸…é™¤å®šæ—¶å™¨ 0 çš„æ¨¡å¼ä½
  82   1          TMOD |= 0x01; // è®¾ç½®å®šæ—¶å™¨ 0 ä¸ºæ¨¡å¼ 1ï¼ˆ16 ä½å®šæ—¶å™¨ï¼‰
  83   1      
  84   1          // åˆå§‹åŒ–å®šæ—¶å™¨0çš„åˆå€¼
  85   1          TH0 = (65536 - TIMER_0_RELOADS_VALUE) / 256;
  86   1          TL0 = (65536 - TIMER_0_RELOADS_VALUE) % 256;
  87   1      
  88   1          // å¼€å¯å…¨å±€ä¸­æ–­
  89   1          EA = 1;
  90   1          // å¼€å¯å®šæ—¶å™¨0ä¸­æ–­
  91   1          ET0 = 1;
  92   1          // å¯åŠ¨å®šæ—¶å™¨0
  93   1          TR0 = 1;
  94   1      }
  95          
  96          // å®šæ—¶å™¨0ä¸­æ–­å¤„ç†å‡½æ•°
  97          void timer0InterruptHandling(void) interrupt 1
  98          {
  99   1          // é‡æ–°è£…è½½å®šæ—¶å™¨0çš„åˆå€¼
 100   1          TH0 = (65536 - TIMER_0_RELOADS_VALUE) / 256;
 101   1          TL0 = (65536 - TIMER_0_RELOADS_VALUE) % 256;
 102   1      
 103   1          // æ¯æ¬¡æº¢å‡ºéƒ½ä½¿ç”¨å½“å‰æ—¶é—´åŠ 1
 104   1          currentTime++;
 105   1      }
 106          
 107          // æ·»åŠ ä»»åŠ¡çš„å‡½æ•°
 108          void addTask(void (*taskFunction)(void), unsigned int period)
 109          {
 110   1          if (taskCount < MAX_TASKS)
 111   1          {
 112   2              tasks[taskCount].taskFunction = taskFunction;
 113   2              tasks[taskCount].period = period;
 114   2              tasks[taskCount].nextExecution = currentTime + period;
 115   2              taskCount++;
C51 COMPILER V9.60.7.0   MAIN                                                              09/24/2024 17:32:50 PAGE 3   

 116   2          }
 117   1      }
 118          
 119          // æ¸©åº¦-æ—¶é—´æ˜¾ç¤ºæ›´æ–°
 120          void taskTemperatureUpdate()
 121          {
 122   1          // è¯»å–æ¸©åº¦
 123   1          temperature = ReadTemperature() * TEMP_CONVERSION_FACTOR;
 124   1      
 125   1          // è®¡ç®—æ¸©åº¦çš„æ•´æ•°éƒ¨åˆ†å’Œå°æ•°éƒ¨åˆ†
 126   1          integerPart = (unsigned int)temperature;
 127   1          decimalPart = (unsigned int)((temperature - integerPart + 0.5) * 100);
 128   1      
 129   1          if(displayTemperatureOrTime==1){
 130   2              // è°ƒç”¨æ™¶ä½“ç®¡æ˜¾ç¤º
 131   2          displayTemperature(integerPart, decimalPart);
 132   2          }else{
 133   2              // è°ƒç”¨æ•°ç ç®¡æ˜¾ç¤º
 134   2          displayTime(60);
 135   2          }
 136   1      }
 137          
 138          void taskControlRelay(){
 139   1          // å¦‚æœæ¸©åº¦ä½äºä¸‹é™æ¸©åº¦
 140   1          if (temperature < LOWER_TEMP_LIMIT) {
 141   2              // æ‰“å¼€ç»§ç”µå™¨
 142   2              relayOpened();
 143   2              // å‘å‡ºèœ‚é¸£å™¨è­¦å‘Š
 144   2              buzzerOn();
 145   2          }
 146   1          // å¦‚æœæ¸©åº¦é«˜äºä¸Šé™æ¸©åº¦
 147   1          else if (temperature > UPPER_TEMP_LIMIT) {
 148   2              // å…³é—­ç»§ç”µå™¨
 149   2              relayClosed();
 150   2              // å‘å‡ºèœ‚é¸£å™¨è­¦å‘Š
 151   2              buzzerOn();
 152   2          }
 153   1          // å¦‚æœæ¸©åº¦åœ¨ä¸Šä¸‹é™ä¹‹é—´
 154   1          else {
 155   2              pIDControl();
 156   2              buzzerOff();
 157   2          }
 158   1      }
 159          
 160          // è°ƒåº¦å™¨å‡½æ•°
 161          void scheduler() {
 162   1          unsigned char i;
 163   1          for (i = 0; i < taskCount; i++) {
 164   2              if (currentTime >= tasks[i].nextExecution) {
 165   3                  tasks[i].taskFunction(); // è°ƒç”¨ä»»åŠ¡å‡½æ•°
 166   3                  tasks[i].nextExecution = currentTime + tasks[i].period; // æ›´æ–°ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´
 167   3              }
 168   2          }
 169   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    349    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     44       1
C51 COMPILER V9.60.7.0   MAIN                                                              09/24/2024 17:32:50 PAGE 4   

   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
